# Feature Specification: 인증/인가 시스템 및 알림 기능

**Feature Branch**: `002-auth-notification-system`
**Created**: 2025-11-25
**Status**: Draft
**Input**: User description: "Critical (즉시 필요) 1. 인증/인가 시스템 완전 누락 - 회원가입 API, 로그인 API, 로그아웃 API, JWT 토큰 발급/갱신; High Priority - Edge Case 처리 검증, OAuth 2.0 소셜 로그인, 알림 시스템"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 회원가입 및 로그인 (Priority: P1)

신규 사용자가 ZipDuck 서비스에 회원가입하고 로그인하여 청약 정보를 조회하고 즐겨찾기를 관리할 수 있습니다.

**Why this priority**: 현재 시스템에 인증 시스템이 완전히 누락되어 있어 사용자 식별이 불가능합니다. 모든 개인화 기능(즐겨찾기, 알림 등)이 사용자 인증에 의존하므로 최우선 구현이 필요합니다.

**Independent Test**: 회원가입 폼에서 이메일과 비밀번호를 입력하여 계정을 생성하고, 생성된 계정으로 로그인하여 JWT 토큰을 받아 사용자 프로필을 조회할 수 있으면 독립적으로 테스트 완료됩니다.

**Acceptance Scenarios**:

1. **Given** 신규 사용자가 회원가입 페이지에 접속한 상태에서, **When** 유효한 이메일, 비밀번호, 이름을 입력하고 가입 버튼을 클릭하면, **Then** 계정이 생성되고 "가입이 완료되었습니다" 메시지가 표시됩니다.

2. **Given** 이미 가입된 사용자가 로그인 페이지에 접속한 상태에서, **When** 올바른 이메일과 비밀번호를 입력하고 로그인 버튼을 클릭하면, **Then** JWT Access Token과 Refresh Token이 발급되고 메인 페이지로 이동합니다.

3. **Given** 로그인한 사용자가, **When** 로그아웃 버튼을 클릭하면, **Then** 세션이 종료되고 발급받은 토큰이 무효화되며 로그인 페이지로 이동합니다.

4. **Given** 사용자의 Access Token이 만료된 상태에서, **When** 보호된 API를 호출하면, **Then** Refresh Token을 사용하여 자동으로 새로운 Access Token을 발급받고 요청이 정상 처리됩니다.

5. **Given** 회원가입 시, **When** 이미 등록된 이메일을 입력하면, **Then** "이미 사용 중인 이메일입니다" 에러 메시지가 표시됩니다.

6. **Given** 로그인 시, **When** 잘못된 비밀번호를 입력하면, **Then** "이메일 또는 비밀번호가 올바르지 않습니다" 에러 메시지가 표시됩니다.

---

### User Story 2 - OAuth 2.0 소셜 로그인 (Priority: P2)

사용자가 Google 또는 Kakao 계정을 사용하여 간편하게 회원가입 및 로그인할 수 있습니다.

**Why this priority**: 사용자 경험을 개선하고 가입 장벽을 낮추어 사용자 유입을 증가시킬 수 있습니다. 기본 인증(P1)이 구현된 후 추가 가능한 기능입니다.

**Independent Test**: Google 로그인 버튼을 클릭하여 Google OAuth 인증을 완료하고 자동으로 계정이 생성되어 JWT 토큰을 받아 로그인 상태가 되면 독립적으로 테스트 완료됩니다.

**Acceptance Scenarios**:

1. **Given** 신규 사용자가 로그인 페이지에서, **When** "Google로 시작하기" 버튼을 클릭하면, **Then** Google OAuth 인증 페이지로 이동하여 Google 계정 선택 및 권한 동의 화면이 표시됩니다.

2. **Given** Google 인증이 완료된 상태에서, **When** 사용자가 권한을 승인하면, **Then** Google 계정 정보로 자동 회원가입되고 JWT 토큰이 발급되어 메인 페이지로 이동합니다.

3. **Given** 기존 Google 계정으로 가입한 사용자가, **When** "Google로 로그인" 버튼을 클릭하면, **Then** Google 인증 후 즉시 로그인되어 기존 데이터(즐겨찾기, 프로필 등)에 접근할 수 있습니다.

4. **Given** 신규 사용자가 로그인 페이지에서, **When** "Kakao로 시작하기" 버튼을 클릭하면, **Then** Kakao OAuth 인증 페이지로 이동하여 Kakao 로그인 및 동의 화면이 표시됩니다.

5. **Given** 이미 일반 회원가입으로 등록된 이메일과 동일한 이메일의 Google 계정으로 로그인을 시도하면, **When** Google 인증이 완료되면, **Then** 기존 계정에 Google 계정이 연동되고 로그인됩니다.

---

### User Story 3 - 청약 알림 구독 (Priority: P2)

사용자가 관심 있는 청약 조건을 설정하면 새로운 청약 공고가 나오거나 마감이 임박할 때 이메일 또는 푸시 알림을 받을 수 있습니다.

**Why this priority**: 사용자가 청약 기회를 놓치지 않도록 돕는 핵심 가치 제안 기능입니다. 인증 시스템(P1)이 구현된 후 사용자별 알림 설정이 가능합니다.

**Independent Test**: 사용자가 알림 설정 페이지에서 특정 지역 및 소득 조건으로 알림을 구독하고, 해당 조건에 맞는 신규 청약이 등록되었을 때 이메일 알림을 받으면 독립적으로 테스트 완료됩니다.

**Acceptance Scenarios**:

1. **Given** 로그인한 사용자가 알림 설정 페이지에서, **When** 특정 지역(예: 서울, 경기)과 소득 조건을 선택하고 "알림 받기" 버튼을 클릭하면, **Then** 해당 조건으로 알림 구독이 등록되고 "알림이 설정되었습니다" 메시지가 표시됩니다.

2. **Given** 사용자가 청약 알림을 구독한 상태에서, **When** 구독 조건에 맞는 새로운 청약 공고가 시스템에 등록되면, **Then** 사용자에게 이메일로 "새로운 청약 공고가 있습니다" 알림이 발송됩니다.

3. **Given** 사용자가 청약 알림을 구독한 상태에서, **When** 구독한 청약의 마감일이 3일 이내로 임박하면, **Then** "청약 마감 임박" 푸시 알림이 발송됩니다.

4. **Given** 사용자가 여러 알림을 구독한 상태에서, **When** 알림 설정 페이지에서 특정 알림의 "구독 취소" 버튼을 클릭하면, **Then** 해당 알림 구독이 해제되고 더 이상 알림을 받지 않습니다.

5. **Given** 사용자가 알림 수신 방법 설정에서, **When** "이메일만" 또는 "푸시만" 또는 "이메일+푸시"를 선택하면, **Then** 선택한 방법으로만 알림이 발송됩니다.

6. **Given** 하루에 동일 조건으로 여러 청약이 등록된 경우, **When** 알림 발송 시점이 되면, **Then** 모든 알림을 하나의 요약 이메일로 통합하여 발송하고 "오늘 3개의 새로운 청약이 있습니다"와 같은 메시지를 표시합니다.

---

### User Story 4 - Edge Case 처리 및 에러 응답 표준화 (Priority: P3)

시스템이 경계값 조건과 예외 상황을 올바르게 처리하여 사용자에게 명확한 피드백을 제공합니다.

**Why this priority**: 사용자 경험과 시스템 안정성을 향상시키는 완성도 개선 작업입니다. 핵심 기능(P1, P2) 구현 후 진행 가능합니다.

**Independent Test**: 소득이 정확히 청약 조건 상한선과 일치하는 사용자가 자격 조회를 하면 정확하게 매칭되고, 조건에 맞는 청약이 0개일 때 "현재 조건에 맞는 청약이 없습니다" 메시지가 표시되면 독립적으로 테스트 완료됩니다.

**Acceptance Scenarios**:

1. **Given** 사용자의 소득이 청약 자격 조건 상한선과 정확히 일치할 때(예: 소득 6천만원, 조건 "6천만원 이하"), **When** 자격 조회를 하면, **Then** 해당 청약이 정상적으로 매칭되어 결과에 포함됩니다.

2. **Given** 사용자의 소득이 청약 자격 조건 하한선과 정확히 일치할 때(예: 소득 3천만원, 조건 "3천만원 이상"), **When** 자격 조회를 하면, **Then** 해당 청약이 정상적으로 매칭되어 결과에 포함됩니다.

3. **Given** 사용자가 자격 조건을 입력한 상태에서, **When** 조건에 맞는 청약이 0개일 때, **Then** "현재 입력하신 조건에 맞는 청약이 없습니다. 조건을 변경하여 다시 시도해주세요."라는 안내 메시지가 표시됩니다.

4. **Given** API 요청 중 서버 오류가 발생하면, **When** 사용자가 기능을 실행하면, **Then** 일관된 형식의 에러 응답(에러 코드, 메시지, 타임스탬프 포함)이 반환되고 사용자에게 "일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요."와 같은 친절한 메시지가 표시됩니다.

5. **Given** 사용자가 잘못된 형식의 데이터를 입력하면(예: 이메일 형식 오류, 음수 소득), **When** 폼을 제출하면, **Then** 입력란 아래에 구체적인 검증 오류 메시지가 표시되고(예: "올바른 이메일 형식을 입력해주세요", "소득은 0 이상이어야 합니다") 제출이 차단됩니다.

---

### Edge Cases

- **경계값 처리**: 사용자의 소득이 청약 자격 조건의 상한선 또는 하한선과 정확히 일치하는 경우 어떻게 처리되는가?
  - 예: 소득 6천만원, 조건 "6천만원 이하" → 포함되어야 함
  - 예: 소득 3천만원, 조건 "3천만원 이상 6천만원 이하" → 포함되어야 함

- **0개 매칭**: 사용자의 조건에 맞는 청약이 0개일 때 어떤 메시지를 표시하는가?
  - 명확한 안내 메시지 필요: "현재 조건에 맞는 청약이 없습니다"
  - 조건 완화 제안 또는 알림 구독 유도

- **토큰 만료**: Access Token이 만료되었을 때 사용자가 API 요청을 하면 어떻게 처리되는가?
  - Refresh Token으로 자동 갱신 시도
  - Refresh Token도 만료된 경우 로그인 페이지로 리다이렉트

- **OAuth 인증 실패**: Google 또는 Kakao OAuth 인증 중 사용자가 권한을 거부하거나 네트워크 오류가 발생하면?
  - 사용자에게 명확한 오류 메시지 표시
  - 일반 로그인 옵션으로 안내

- **중복 알림**: 동일한 청약에 대해 여러 번 알림이 발송되지 않도록 처리
  - 알림 발송 이력 추적
  - 24시간 내 동일 청약에 대한 중복 알림 차단

- **동시 로그인**: 한 계정으로 여러 디바이스에서 동시 로그인할 때 세션 관리는 어떻게 되는가?
  - 다중 디바이스 로그인 허용
  - 보안상 민감한 작업(비밀번호 변경 등)은 재인증 요구

- **대량 알림 발송**: 수천 명의 사용자에게 동시에 알림을 발송할 때 시스템 부하 관리
  - 배치 처리 및 큐잉 시스템 사용
  - 알림 발송 실패 시 재시도 로직

## Requirements *(mandatory)*

### Functional Requirements

**인증/인가 (P1)**

- **FR-001**: 시스템은 이메일과 비밀번호를 사용한 회원가입 기능을 제공해야 합니다.
- **FR-002**: 시스템은 회원가입 시 이메일 형식 검증 및 비밀번호 강도 검증(최소 8자, 영문+숫자 조합)을 수행해야 합니다.
- **FR-003**: 시스템은 이메일 중복 체크를 수행하고 이미 등록된 이메일은 가입을 차단해야 합니다.
- **FR-004**: 시스템은 로그인 시 이메일과 비밀번호를 검증하고 인증 성공 시 JWT Access Token(유효기간 1시간)과 Refresh Token(유효기간 7일)을 발급해야 합니다.
- **FR-005**: 시스템은 로그아웃 시 Refresh Token을 무효화하고 클라이언트의 토큰을 삭제해야 합니다.
- **FR-006**: 시스템은 Access Token 만료 시 Refresh Token을 사용하여 자동으로 새로운 Access Token을 발급하는 토큰 갱신 API를 제공해야 합니다.
- **FR-007**: 시스템은 보호된 API 엔드포인트에 대해 유효한 JWT 토큰이 있는 경우에만 접근을 허용해야 합니다.
- **FR-008**: 시스템은 비밀번호를 암호화하여 저장해야 합니다(평문 저장 금지).

**OAuth 2.0 소셜 로그인 (P2)**

- **FR-009**: 시스템은 Google OAuth 2.0을 통한 회원가입 및 로그인 기능을 제공해야 합니다.
- **FR-010**: 시스템은 Kakao OAuth 2.0을 통한 회원가입 및 로그인 기능을 제공해야 합니다.
- **FR-011**: 시스템은 OAuth 인증 성공 시 소셜 계정 정보(이메일, 이름, 프로필 이미지)를 사용하여 자동으로 회원가입을 처리해야 합니다.
- **FR-012**: 시스템은 이미 등록된 이메일과 동일한 이메일의 소셜 계정으로 로그인 시 기존 계정에 소셜 계정을 연동해야 합니다.
- **FR-013**: 시스템은 OAuth 인증 실패 시 사용자에게 명확한 오류 메시지를 제공하고 일반 로그인 옵션을 안내해야 합니다.

**알림 시스템 (P2)**

- **FR-014**: 시스템은 사용자가 지역, 소득 범위 등의 조건으로 청약 알림을 구독할 수 있는 기능을 제공해야 합니다.
- **FR-015**: 시스템은 사용자가 구독한 조건에 맞는 새로운 청약 공고가 등록되면 알림을 발송해야 합니다.
- **FR-016**: 시스템은 청약 마감일이 3일 이내로 임박한 경우 사용자에게 마감 임박 알림을 발송해야 합니다.
- **FR-017**: 시스템은 이메일 알림과 푸시 알림을 지원하고 사용자가 수신 방법을 선택할 수 있어야 합니다.
- **FR-018**: 시스템은 사용자가 알림 구독을 관리(추가, 수정, 삭제)할 수 있는 기능을 제공해야 합니다.
- **FR-019**: 시스템은 동일한 청약에 대해 24시간 내 중복 알림을 발송하지 않아야 합니다.
- **FR-020**: 시스템은 하루에 동일 조건으로 여러 청약이 등록된 경우 알림을 하나의 요약으로 통합하여 발송해야 합니다.

**Edge Case 및 에러 처리 (P3)**

- **FR-021**: 시스템은 사용자의 소득이 청약 자격 조건의 상한선 또는 하한선과 정확히 일치하는 경우 정상적으로 매칭되어야 합니다(경계값 포함).
- **FR-022**: 시스템은 사용자의 조건에 맞는 청약이 0개일 때 "현재 조건에 맞는 청약이 없습니다. 조건을 변경하여 다시 시도해주세요."와 같은 명확한 메시지를 반환해야 합니다.
- **FR-023**: 시스템은 모든 API 에러 응답을 표준화된 형식(에러 코드, 메시지, 타임스탬프 포함)으로 반환해야 합니다.
- **FR-024**: 시스템은 사용자 입력 검증 오류 시 구체적이고 사용자 친화적인 오류 메시지를 제공해야 합니다(예: "올바른 이메일 형식을 입력해주세요").
- **FR-025**: 시스템은 서버 오류 발생 시 사용자에게 기술적 세부사항 대신 친절한 안내 메시지를 표시해야 합니다(예: "일시적인 오류가 발생했습니다").

### Key Entities

- **User (사용자)**: 서비스에 가입한 사용자 정보
  - 속성: 사용자 ID, 이메일, 비밀번호(암호화), 이름, 가입일, 프로필 이미지, 계정 상태(활성/비활성)
  - 관계: 여러 개의 Notification Subscription과 연결

- **OAuth Account (소셜 계정)**: 사용자의 소셜 로그인 정보
  - 속성: 소셜 계정 ID, 제공자(Google/Kakao), 소셜 사용자 ID, 연동일
  - 관계: 하나의 User에 속함

- **Refresh Token (리프레시 토큰)**: 토큰 갱신을 위한 토큰 정보
  - 속성: 토큰 ID, 토큰 값, 발급일, 만료일, 무효화 여부
  - 관계: 하나의 User에 속함

- **Notification Subscription (알림 구독)**: 사용자의 알림 구독 설정
  - 속성: 구독 ID, 지역 조건, 소득 범위, 알림 타입(신규/마감임박), 수신 방법(이메일/푸시), 활성 여부, 생성일
  - 관계: 하나의 User에 속함

- **Notification Log (알림 발송 이력)**: 발송된 알림의 이력
  - 속성: 알림 ID, 청약 ID, 발송일시, 발송 타입(이메일/푸시), 발송 상태(성공/실패), 실패 사유
  - 관계: 하나의 User와 하나의 Subscription에 속함

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 사용자가 회원가입부터 로그인까지 2분 이내에 완료할 수 있어야 합니다.
- **SC-002**: 소셜 로그인(Google/Kakao)을 통한 가입 및 로그인이 30초 이내에 완료되어야 합니다.
- **SC-003**: 로그인한 사용자가 보호된 API에 접근할 때 토큰 검증이 100ms 이내에 완료되어야 합니다.
- **SC-004**: 청약 알림이 새로운 공고 등록 후 5분 이내에 발송되어야 합니다.
- **SC-005**: 마감 임박 알림이 마감 3일 전 오전 9시에 정확히 발송되어야 합니다.
- **SC-006**: 알림 발송 성공률이 95% 이상이어야 합니다(네트워크 오류 등 제외).
- **SC-007**: 사용자가 알림 구독 설정을 변경하면 즉시 반영되어야 합니다(1분 이내).
- **SC-008**: 경계값 조건(소득 정확히 일치)에서의 매칭 정확도가 100%여야 합니다.
- **SC-009**: 모든 API 에러 응답이 표준화된 형식을 따라야 합니다(100% 준수).
- **SC-010**: 사용자가 0개 매칭 결과를 받았을 때 95% 이상이 메시지를 이해하고 조건을 변경하거나 알림을 구독해야 합니다.
- **SC-011**: Access Token 만료 시 사용자가 로그인 중단 없이 자동으로 토큰이 갱신되어야 합니다(사용자 인지 불가).
- **SC-012**: 시스템이 1000명의 사용자에게 동시에 알림을 발송할 때 10분 이내에 모든 발송을 완료해야 합니다.

## Assumptions

1. **이메일 서비스**: 이메일 알림 발송을 위해 외부 이메일 서비스(예: SendGrid, AWS SES)를 사용할 것으로 가정합니다.

2. **푸시 알림**: 모바일 푸시 알림은 FCM(Firebase Cloud Messaging) 또는 유사한 서비스를 통해 구현할 것으로 가정합니다.

3. **비밀번호 정책**: 비밀번호는 최소 8자 이상, 영문과 숫자 조합을 기본 정책으로 가정합니다. 특수문자 포함 여부는 선택사항으로 남겨둡니다.

4. **토큰 유효기간**:
   - Access Token: 1시간
   - Refresh Token: 7일
   (보안 정책에 따라 조정 가능)

5. **알림 발송 시간**: 마감 임박 알림은 마감 3일 전 오전 9시를 기본으로 가정하며, 추후 사용자가 선호 시간을 설정할 수 있도록 확장 가능합니다.

6. **OAuth 제공자**: 우선 Google과 Kakao를 지원하며, Naver 등 추가 제공자는 향후 확장 가능합니다.

7. **다중 디바이스 로그인**: 한 계정으로 여러 디바이스에서 동시 로그인을 허용하는 것으로 가정합니다.

8. **알림 요약 주기**: 하루 단위로 동일 조건의 여러 청약을 하나의 요약 알림으로 통합합니다.

9. **기존 데이터**: 현재 시스템에 사용자 인증 없이 저장된 데이터(즐겨찾기 등)가 있다면, 마이그레이션 계획이 별도로 필요할 수 있습니다.

10. **에러 응답 형식**: 표준화된 에러 응답은 다음 정보를 포함합니다:
    - HTTP 상태 코드
    - 에러 코드(예: AUTH001, NOTI002)
    - 사용자 친화적 메시지
    - 타임스탬프
    - 요청 ID(디버깅용, 선택사항)
